"use strict";angular.module("tipExpert.user",["ngCookies"]),angular.module("tipExpert.match",[]),angular.module("tipExpert.game",[]),angular.module("tipExpert.home",[]);var tipExpert=angular.module("tipExpert",["tipExpert.home","tipExpert.user","tipExpert.match","tipExpert.game","ui.bootstrap","ui.router","pascalprecht.translate","ngCookies"]);tipExpert.config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(e,r,t,a){var o=userConfig.accessLevels,n={header:{templateUrl:"/js/home/views/header.html",controller:"navigationController"},main:{template:"<ui-view/>"}};e.state("user",{url:"/user",views:n,"abstract":!0}).state("user.overview",{title:"Users",url:"",templateUrl:"/js/user/views/user.html",controller:"userController",access:o.user}).state("user.profile",{title:"User profile",url:"/:userId",templateUrl:"/js/user/views/profile.html",controller:"userProfileController",access:o.user}).state("matches",{url:"/matches",views:n,"abstract":!0}).state("matches.overview",{title:"Matches",url:"",templateUrl:"/js/match/views/matches.html",controller:"matchController",access:o.admin}).state("matches.finished",{title:"Not implemented yet!",url:"/finished",templateUrl:"todo",controller:"finishedMatchesController",access:o.admin}).state("games",{url:"/games",views:n,"abstract":!0}).state("games.overview",{title:"Games",url:"",templateUrl:"/js/game/views/myGames.html",controller:"myGamesController",access:o.user}).state("games.history",{title:"Games History",url:"/history",templateUrl:"/js/game/views/gamesHistory.html",controller:"gamesHistoryController",access:o.user}).state("games.create",{title:"Create game",url:"/create",templateUrl:"/js/game/views/editGame.html",controller:"editGameController",access:o.user}).state("games.edit",{title:"Edit game",url:"/:gameId/edit",templateUrl:"/js/game/views/editGame.html",controller:"editGameController",access:o.user}).state("games.show",{title:"Game",url:"/:gameId",templateUrl:"/js/game/views/game.html",controller:"gameController",access:o.user}).state("home",{title:"Home",url:"/",views:{header:{templateUrl:"/js/home/views/loginHeader.html",controller:"navigationController"},main:{templateUrl:"/js/home/views/index.html",controller:"homeController"}},access:o["public"]}),r.otherwise("/"),t.html5Mode({enabled:!0,requireBase:!1}),a.interceptors.push(["$q","$location",function(e,r){return{responseError:function(t){return 401===t.status||403===t.status?(r.path("/"),e.reject(t)):e.reject(t)}}}])}]),tipExpert.config(["$translateProvider",function(e){e.fallbackLanguage("en").registerAvailableLanguageKeys(["en","de"],{en_US:"en",en_UK:"en",de_DE:"de",de_CH:"de",de_AT:"de"}),e.useCookieStorage(),e.determinePreferredLanguage();var r=window.location.origin||window.location.protocol+"//"+window.location.host;e.useStaticFilesLoader({prefix:r+"/locales/",suffix:".json"})}]),tipExpert.run(["$rootScope","$location","$state","authService","alertService",function(e,r,t,a,o){e.$state=t,e.$on("$stateChangeStart",function(e,r,n,i,s){var c=a.user.isLoggedIn;a.authorize(r.access)?"home"==r.name&&c&&(e.preventDefault(),t.go("games.overview")):(e.preventDefault(),c?(i.controller||t.go("games.overview"),o.error("You are not allowed to access this page")):t.go("home"))})}]),function(e){e.roles={admin:1,user:2,"public":3},e.accessLevels={admin:1,user:2,"public":3}}("undefined"==typeof exports?this.userConfig={}:exports);var game=angular.module("tipExpert.game");game.controller("AddGameController",["$scope","$modalInstance","$state","gameService","alertService",function(e,r,t,a,o){e.game={},e.save=function(){e.submitted=!0,this.addGameForm.$invalid||a.create(e.game,function(e){r.close(),t.go("games.edit",{gameId:e._id})},o.error)},e.cancel=function(){r.dismiss("cancel")}}]);var game=angular.module("tipExpert.game");game.controller("editGameController",["$scope","$state","$stateParams","$modal","gameService","alertService",function(e,r,t,a,o,n){e.game={},t.gameId&&o.loadForEdit(t.gameId,function(r){e.game=r},n.error),e.save=function(){e.submitted=!0,e.submitForm.$invalid||o.update(e.game,function(r){e.game=r,n.info("Successfully saved!")},n.error)},e["delete"]=function(){return e.game.isFinished?void n.error("Can not delete a finished game!"):void o["delete"](e.game,function(){n.info("Successfully deleted!"),r.go("games.overview")},n.error)},e.addMatch=function(){var r=a.open({templateUrl:"/modules/game/views/selectMatchesDialog.html",controller:"SelectMatchesController",resolve:{game:function(){return e.game}}});r.result.then(function(r){e.game=r,n.info("Changes successfully saved!")},function(){})},e.addPlayer=function(){var r=a.open({templateUrl:"/modules/game/views/selectPlayersDialog.html",controller:"SelectPlayersController",resolve:{game:function(){return e.game}}});r.result.then(function(r){e.game=r,n.info("Changes successfully saved!")},function(){})}}]);var game=angular.module("tipExpert.game");game.controller("gameController",["$scope","$modal","$stateParams","gameService","alertService",function(e,r,t,a,o){e.game={},e.submitted=!0,e.minStake=0,e.stake=0,e.editStake=!1,e.cancelEditStake=function(){e.stake=e.game.player.stake,e.editStake=!1},e.saveStake=function(){a.updateStake(e.game.id,e.game.player.id,e.stake,function(){e.game.player.stake=e.stake,e.editStake=!1},o.error)},e.saveTip=function(r){a.updateTip(e.game.id,r.match,r,function(e,t){r.oldHomeTip=e,r.oldGuestTip=t,r.showSaveButton=!1},o.error)},e.cancelTipEditing=function(e){e.homeTip=e.oldHomeTip,e.guestTip=e.oldGuestTip,e.showSaveButton=!1},t.gameId&&a.load(t.gameId,function(r){e.game=r,e.minStake=r.minStake,e.stake=r.player.stake},o.error)}]);var game=angular.module("tipExpert.game");game.controller("gamesHistoryController",["$scope","$modal","gameService","alertService",function(e,r,t,a){e.games=[],t.loadFinishedGamesForCurrentUser().then(function(r){e.games=r})["catch"](a.error)}]);var game=angular.module("tipExpert.game");game.controller("myGamesController",["$scope","$modal","gameService","alertService",function(e,r,t,a){e.createdGames=[],e.invitedGames=[],e.createGame=function(){r.open({templateUrl:"modules/game/views/addGameDialog.html",controller:"AddGameController"})},t.loadGamesCreatedByCurrentUser().then(function(r){e.createdGames=r})["catch"](a.error),t.loadGamesForCurrentUser().then(function(r){e.invitedGames=r})["catch"](a.error)}]);var game=angular.module("tipExpert.game");game.controller("SelectMatchesController",["$scope","$modalInstance","leagueService","matchService","gameService","alertService","game",function(e,r,t,a,o,n,i){var s=i.matches.slice(0),c=function(e,r){return e.homeTeam==r.homeTeam&&e.guestTeam==r.guestTeam&&e.dueDate==r.dueDate&&e.league==r.league};e.loadMatches=function(r){a.load(r,function(r){e.matches=r,angular.forEach(r,function(e){angular.forEach(s,function(r){c(e,r.match)&&(e.selected=!0)})})},n.error)},e.toggleMatchSelection=function(e){if(e.selected=!e.selected,e.selected){var r={match:e};s.push(r)}else angular.forEach(s,function(r){if(c(e,r.match)){var t=s.indexOf(r);s.splice(t,1)}})},e.save=function(){i.matches=s,o.update(i,function(e){r.close(e)},n.error)},e.cancel=function(){r.dismiss("cancel")},t.load(function(r){e.leagues=r,r.length>0&&(e.league=r[0],e.loadMatches(e.league))},n.error)}]);var game=angular.module("tipExpert.game");game.controller("SelectPlayersController",["$scope","$modalInstance","Auth","userService","gameService","alertService","game",function(e,r,t,a,o,n,i){var s=i.players.slice(0),c=function(e,r){return e.name==r.name};e.toggleUserSelection=function(e){if(e.selected=!e.selected,e.selected){var r={user:e};s.push(r)}else angular.forEach(s,function(r){if(c(e,r.user)){var t=s.indexOf(r);s.splice(t,1)}})},e.save=function(){i.players=s,o.update(i,function(e){r.close(e)},n.error)},e.cancel=function(){r.dismiss("cancel")},a.loadFriendsForUser(t.currentUser).then(function(r){e.users=r,angular.forEach(r,function(e){angular.forEach(s,function(r){c(e,r.user)&&(e.selected=!0)})})})["catch"](n.error)}]);var game=angular.module("tipExpert.game");game.factory("gameService",["$http","$q",function(e,r){return{loadGamesForCurrentUser:function(){var t=r.defer();return e.get("/api/games/invited").success(t.resolve).error(t.reject),t.promise},loadGamesCreatedByCurrentUser:function(){var t=r.defer();return e.get("/api/games/created").success(t.resolve).error(t.reject),t.promise},loadFinishedGamesForCurrentUser:function(){var t=r.defer();return e.get("/api/games/finished").success(t.resolve).error(t.reject),t.promise},load:function(r,t,a){e.get("/api/games/"+r).success(function(e,r,a,o){t(e)}).error(a)},loadForEdit:function(r,t,a){e.get("/api/games/"+r+"/edit").success(function(e,r,a,o){t(e)}).error(a)},create:function(r,t,a){e.post("/api/games",r).success(function(e,r,a,o){t(e)}).error(a)},update:function(r,t,a){e.put("/api/games/"+r._id+"/edit",r).success(function(e,r,a,o){t(e)}).error(a)},updateStake:function(r,t,a,o,n){e.put("/api/games/"+r+"/stake",{playerId:t,stake:a}).success(function(e,r,t,a){o()}).error(n)},updateTip:function(r,t,a,o,n){e.put("/api/games/"+r+"/tip",{tip:a.id,match:t,homeTip:a.homeTip,guestTip:a.guestTip}).success(function(e,r,t,a){o(e.homeTip,e.guestTip)}).error(n)},"delete":function(r,t,a){e["delete"]("/api/games/"+r._id+"/edit").success(t).error(a)}}}]);var match=angular.module("tipExpert.match");match.controller("EditMatchController",["$scope","$modalInstance","matchService","alertService","match",function(e,r,t,a,o){e.match=o,e.save=function(){var e=function(e){r.close(e)};o.id?t.update(o,e,a.error):t.create(o,e,a.error)},e.cancel=function(){r.dismiss("cancel")}}]);var match=angular.module("tipExpert.match");match.controller("matchController",["$scope","$modal","leagueService","matchService","alertService",function(e,r,t,a,o){e.selectedMatch={homeTeam:"",guestTeam:"",dueDate:new Date},e.leagues=[],e.newLeague={name:""},e.addLeague=function(){t.create(e.newLeague,function(r){r.editorEnabled=!1,e.newLeague=""}),function(e){alert(e)}},e.removeLeague=function(e){t["delete"](e,function(e){alert(e)})},e.editLeague=function(e){e.editorEnabled=!0,e.editableName=e.name},e.cancelEditLeague=function(e){e.editorEnabled=!1},e.saveLeague=function(e){e.name=e.editableName,t.update(e,function(){e.editorEnabled=!1},o.error)};var n=function(e,t){var a=r.open({templateUrl:"/js/match/views/editMatchDialog.html",controller:"EditMatchController",resolve:{match:function(){return e}}});a.result.then(function(e){t&&t(e)},function(){})};e.loadMatches=function(r){e.selectedLeague=r,a.load(r,function(r){e.matches=r},o.error)},e.addMatch=function(){var r={homeTeam:"",guestTeam:"",dueDate:Date.now(),leagueId:e.selectedLeague.id};n(r,function(r){e.matches.push(r)})},e.editMatch=function(e){n(e)},t.load(function(r){e.leagues=r,angular.forEach(e.leagues,function(e){e.editorEnabled=!1}),e.leagues.length>0&&e.loadMatches(e.leagues[0])},function(e){alert(e)})}]);var matchModule=angular.module("tipExpert.match");matchModule.factory("leagueService",["$http",function(e){var r=[];return{load:function(t,a){return r.length>0?void t(r):void e.get("/api/leagues").success(function(e){r.length=0,angular.forEach(e,function(e){r.push(e)}),t(r)}).error(a)},create:function(t,a,o){e.post("api/leagues/",t).success(function(e){r.push(e),a(e)}).error(o)},update:function(r,t,a){e.put("/api/leagues/"+r.id,r).success(function(e){t()}).error(a)},"delete":function(t,a){e["delete"]("api/leagues/"+t.id).success(function(){var e=r.indexOf(t);r.splice(e,1)}).error(a)}}}]);var matchModule=angular.module("tipExpert.match");matchModule.factory("matchService",["$http",function(e){return{load:function(r,t,a){e.get("/api/leagues/"+r.id+"/matches").success(function(e){t(e)}).error(a)},create:function(r,t,a){e.post("api/matches/",r).success(function(e){t(e)}).error(a)},update:function(r,t,a){e.put("/api/matches/"+r.id,r).success(function(e){t(e)}).error(a)},"delete":function(r,t){e["delete"]("api/matches/"+r.id).error(t)}}}]);var homeModule=angular.module("tipExpert.home");homeModule.controller("homeController",["$scope","$state","$window","authService","alertService",function(e,r,t,a,o){e.user={name:"",email:"",password:""},e.signup=function(){e.submitted=!0,e.submitForm.$invalid||a.signup(e.user).then(function(){r.go("games.overview")})["catch"](o.error)},e.loginOauth=function(e){t.location.href="/auth/"+e}}]);var user=angular.module("tipExpert.user");user.controller("languageController",["$scope","$translate",function(e,r){e.changeLanguage=function(e){r.use(e)}}]);var user=angular.module("tipExpert.user");user.controller("navigationController",["$scope","$state","authService","alertService",function(e,r,t,a){e.user=t.user,e.logout=function(){t.logout(function(){r.go("home")},a.error)},e.login=function(){e.submitted=!0,e.loginForm.$invalid||t.login({Email:"T@T.COM",Password:"T@T.COM"},function(e){r.go("games.overview")},a.error)},e.loginOauth=function(e){$window.location.href="/auth/"+e},e.alerts=a.alerts,e.closeAlert=function(e){a.closeAlert(e)}}]);var user=angular.module("tipExpert.user");user.factory("alertService",["$timeout",function(e){var r=[],t=function(t,o){var n="An error occoured";void 0!=t&&(n=void 0!=t.msg?t.msg:void 0!=t.errors?t.errors[0]:t);var i={msg:n,type:o};i.timeout=e(function(){a(i)},5e3),r.push(i)},a=function(t){t.timeout&&e.cancel(t.timeout);var a=r.indexOf(t);r.splice(a,1)};return{alerts:r,error:function(e){t(e,"warning")},info:function(e){t(e,"success")},closeAlert:function(e){a(r[e])}}}]);var user=angular.module("tipExpert.user");user.controller("userController",["$scope","userService","alertService",function(e,r,t){e.roles=[{name:"Admin",index:1},{name:"User",index:2}],e.save=function(){r.update(e.users).then(function(){t.info("Successfully saved.")})["catch"](t.error)},r.loadAllUser().then(function(r){e.users=r})["catch"](t.error)}]);var user=angular.module("tipExpert.user");user.controller("userProfileController",["$scope","$stateParams","userService","alertService",function(e,r,t,a){e.user={},e.hideRole=!0,r.userId&&t.loadProfile(r.userId).then(function(r){e.user=r,e.hideRole=r.role==userConfig.roles.user})["catch"](a.error)}]);var userModule=angular.module("tipExpert.user");userModule.factory("authService",["$http","$q","$cookieStore","userService",function(e,r,t,a){var o=userConfig.accessLevels,n=userConfig.roles,i=t.get("user")||{id:"",name:"",role:n["public"],email:""};i.isLoggedIn=i.role==n.user||i.role==n.admin;var s=function(e){t.remove("user"),i.id=e.id,i.name=e.name,i.role=e.role,i.email=e.email,i.picture=e.picture,i.coins=e.coins,i.isLoggedIn=e.role==n.user||e.role==n.admin,i.isAdmin=e.role==n.admin,t.put("user",i)},c=function(){var e=i.id;e&&""!=e&&a.loadProfile(e).then(s)};return c(),{authorize:function(e,r){return void 0===r&&(r=i.role),e==o.admin?r==n.admin:e==o.user?r==n.admin||r==n.user:!0},signup:function(t){var a=r.defer();return e.post("/signup",t).success(function(e){s(e),a.resolve(e)}).error(a.reject),a.promise},login:function(r,t,a){e.post("/api/Account/Login",r).success(function(e){s(e),t(e)}).error(a)},logout:function(r,t){e.post("/logout").success(function(){s({username:"",role:n["public"]}),r()}).error(t)},reloadCurrentUserProfile:c,user:i}}]);var user=angular.module("tipExpert.user");user.factory("userService",["$http","$q",function(e,r){var t=[],a=function(){var a=r.defer();return t.length>0?(a.resolve(t),a.promise):(e.get("/api/user").success(function(e,r,o,n){angular.forEach(e,function(e){t.push(e)}),a.resolve(t)}).error(a.reject),a.promise)};return{loadAllUser:a,loadFriendsForUser:function(e){return a()},loadProfile:function(t){var a=r.defer();return e.get("/api/user/"+t).success(a.resolve).error(a.reject),a.promise},update:function(t){var a=r.defer(),o=[];return angular.forEach(t,function(r){o.push(e.put("/api/user/"+r._id,r))}),r.all(o).then(a.resolve)["catch"](function(e){a.reject(e.data)}),a.promise}}}]);